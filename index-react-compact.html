<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Simple Images Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      if (
        localStorage.getItem('color-theme') === 'dark' ||
        (!('color-theme' in localStorage) &&
          window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React

      // Custom Hooks
      const useTheme = () => {
        const [isDark, setIsDark] = useState(
          document.documentElement.classList.contains('dark')
        )
        const toggle = () => {
          const newTheme = !isDark
          setIsDark(newTheme)
          document.documentElement.classList[newTheme ? 'add' : 'remove'](
            'dark'
          )
          localStorage.setItem('color-theme', newTheme ? 'dark' : 'light')
        }
        return [isDark, toggle]
      }

      const useModal = () => {
        const [image, setImage] = useState(null)
        const open = (src) => setImage(src)
        const close = () => setImage(null)
        useEffect(() => {
          const handleKeyDown = (e) => e.key === 'Escape' && image && close()
          document.addEventListener('keydown', handleKeyDown)
          return () => document.removeEventListener('keydown', handleKeyDown)
        }, [image])
        return [image, open, close]
      }

      const useFileLoader = () => {
        const [items, setItems] = useState([])
        const [filename, setFilename] = useState('urls.txt')
        const load = (e) => {
          const file = e.target.files[0]
          if (!file) return
          setFilename(file.name)
          const reader = new FileReader()
          reader.onload = (evt) => {
            const lines = evt.target.result
              .split('\n')
              .map((l) => l.trim())
              .filter((l) => l)
            const newItems = lines
              .map((line) => {
                if (!line) return null
                const pathMatch = line.match(/https?:\/\/[^,\s"]+|\/[^,\s"]+/)
                const path = pathMatch ? pathMatch[0] : line
                const isUrl =
                  path.startsWith('http://') || path.startsWith('https://')
                return {
                  src: isUrl ? path : `file://${path}`,
                  title: path.split(/[\\/]/).pop() || path,
                  type: isUrl ? 'url' : 'file',
                }
              })
              .filter(Boolean)
            setItems(newItems)
          }
          reader.readAsText(file)
        }
        return [items, filename, setFilename, load]
      }

      const usePagination = (items, filters, pageSize = 1000) => {
        const [currentPage, setCurrentPage] = useState(1)
        const filteredItems = items.filter((item) => filters[item.type])
        const totalPages = Math.ceil(filteredItems.length / pageSize)
        const pageItems = filteredItems.slice(
          (currentPage - 1) * pageSize,
          currentPage * pageSize
        )
        const getPages = () => {
          if (totalPages <= 1) return []
          const pages = new Set([1, totalPages])
          for (let i = 0; i <= 1; i++) {
            if (currentPage - i > 0) pages.add(currentPage - i)
            if (currentPage + i <= totalPages) pages.add(currentPage + i)
          }
          return Array.from(pages).sort((a, b) => a - b)
        }
        return [currentPage, setCurrentPage, totalPages, pageItems, getPages]
      }

      // Components
      const ThemeToggle = ({ isDark, onToggle }) => (
        <button
          onClick={onToggle}
          className="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5"
        >
          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path
              d={
                isDark
                  ? 'M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z'
                  : 'M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z'
              }
              fillRule="evenodd"
              clipRule="evenodd"
            />
          </svg>
        </button>
      )

      const FilterControls = ({ filters, onChange }) => (
        <div className="flex items-center space-x-4">
          <span className="text-sm font-medium text-gray-900 dark:text-white">
            フィルター:
          </span>
          {[
            { key: 'url', label: 'URL' },
            { key: 'file', label: 'File' },
            { key: 'squareOnly', label: '正方形のみ' },
          ].map(({ key, label }) => (
            <div key={key} className="flex items-center">
              <input
                id={`filter-${key}`}
                type="checkbox"
                checked={filters[key]}
                onChange={(e) => onChange(key, e.target.checked)}
                className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
              />
              <label
                htmlFor={`filter-${key}`}
                className="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300"
              >
                {label}
              </label>
            </div>
          ))}
        </div>
      )

      const GridControl = ({ size, onChange }) => (
        <div className="flex items-center space-x-2">
          <label className="text-sm font-medium text-gray-900 dark:text-white">
            Grid:
          </label>
          <input
            type="range"
            min="2"
            max="20"
            value={size}
            onChange={(e) => onChange(parseInt(e.target.value))}
            className="w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
          />
          <span className="text-sm font-medium text-gray-900 dark:text-white w-6 text-center">
            {size}
          </span>
        </div>
      )

      const FileInput = ({ filename, onFilenameChange, onFileLoad }) => (
        <div className="flex flex-wrap md:flex-nowrap gap-4 mb-6">
          <input
            type="file"
            onChange={onFileLoad}
            className="w-full md:w-2/3 text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600"
            accept=".txt,.csv,.tsv,.log,text/plain,text/csv"
          />
          <input
            type="text"
            value={filename}
            onChange={(e) => onFilenameChange(e.target.value)}
            className="w-full md:w-1/3 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            placeholder="ファイル名 (任意)"
          />
        </div>
      )

      const Pagination = ({ current, total, pages, onChange }) =>
        total > 1 && (
          <nav className="relative flex justify-center items-center mb-8 h-10">
            <button
              onClick={() => onChange(current - 1)}
              disabled={current === 1}
              className={`absolute left-0 px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                current === 1
                  ? 'bg-gray-100 text-gray-400 cursor-not-allowed dark:bg-gray-800 dark:text-gray-500'
                  : 'bg-white text-gray-700 border hover:bg-gray-100 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700'
              }`}
            >
              前へ
            </button>
            <ul className="flex items-center space-x-2">
              {pages().map((page, i, arr) => (
                <React.Fragment key={page}>
                  {i > 0 && page - arr[i - 1] > 1 && (
                    <li className="px-1.5 py-1.5 text-gray-500 dark:text-gray-400">
                      ...
                    </li>
                  )}
                  <li>
                    <button
                      onClick={() => onChange(page)}
                      className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                        page === current
                          ? 'bg-blue-600 text-white'
                          : 'bg-white text-gray-700 border hover:bg-gray-100 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700'
                      }`}
                    >
                      {page}
                    </button>
                  </li>
                </React.Fragment>
              ))}
            </ul>
            <button
              onClick={() => onChange(current + 1)}
              disabled={current === total}
              className={`absolute right-0 px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                current === total
                  ? 'bg-gray-100 text-gray-400 cursor-not-allowed dark:bg-gray-800 dark:text-gray-500'
                  : 'bg-white text-gray-700 border hover:bg-gray-100 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700'
              }`}
            >
              次へ
            </button>
          </nav>
        )

      const ImageCard = ({ item, onClick, filters }) => {
        const [isSquare, setIsSquare] = useState(false)
        const [error, setError] = useState(false)
        if (filters.squareOnly && !isSquare) return null
        return (
          <div
            className="group cursor-pointer relative aspect-square"
            onClick={() => onClick(item.src)}
          >
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden h-full transition-transform duration-200 group-hover:scale-105">
              {!error ? (
                <img
                  src={item.src}
                  alt={item.title}
                  loading="lazy"
                  className="w-full h-full object-cover"
                  onLoad={(e) =>
                    setIsSquare(
                      e.target.naturalWidth === e.target.naturalHeight
                    )
                  }
                  onError={() => setError(true)}
                />
              ) : (
                <div className="w-full h-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                  <svg
                    className="w-1/3 h-1/3 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01"
                    />
                  </svg>
                </div>
              )}
              {isSquare && !filters.squareOnly && (
                <div
                  className="absolute top-1.5 right-1.5 text-yellow-400 drop-shadow-lg"
                  title="正方形の画像"
                >
                  <svg
                    className="w-6 h-6"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      fillRule="evenodd"
                      d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z"
                      clipRule="evenodd"
                    />
                  </svg>
                </div>
              )}
              <div className="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/70 to-transparent">
                <div
                  className="font-semibold text-sm text-white truncate"
                  title={item.title}
                >
                  {item.title}
                </div>
              </div>
            </div>
          </div>
        )
      }

      const Modal = ({ image, onClose }) =>
        image && (
          <div
            className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
            onClick={(e) => e.target === e.currentTarget && onClose()}
          >
            <div className="relative">
              <img
                src={image}
                alt="Enlarged"
                className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-xl"
              />
              <button
                onClick={onClose}
                className="absolute -top-4 -right-4 text-white bg-gray-800 bg-opacity-50 rounded-full p-1 hover:bg-opacity-75"
              >
                <svg
                  className="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          </div>
        )

      const App = () => {
        const [isDark, toggleTheme] = useTheme()
        const [modalImage, openModal, closeModal] = useModal()
        const [items, filename, setFilename, loadFile] = useFileLoader()
        const [filters, setFilters] = useState({
          url: true,
          file: true,
          squareOnly: false,
        })
        const [gridSize, setGridSize] = useState(
          () => parseInt(localStorage.getItem('grid-cols')) || 10
        )
        const [currentPage, setCurrentPage, totalPages, pageItems, getPages] =
          usePagination(items, filters)

        const handleFilterChange = (type, value) => {
          setFilters((prev) => ({ ...prev, [type]: value }))
          setCurrentPage(1)
        }

        const handleGridChange = (size) => {
          setGridSize(size)
          localStorage.setItem('grid-cols', size)
        }

        const handleFileLoad = (e) => {
          loadFile(e)
          setCurrentPage(1)
        }

        return (
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold tracking-tight text-gray-900 dark:text-white">
                画像一覧
              </h1>
              <ThemeToggle isDark={isDark} onToggle={toggleTheme} />
            </div>
            <div className="flex flex-wrap items-center justify-between gap-y-4 mb-6">
              <FilterControls filters={filters} onChange={handleFilterChange} />
              <GridControl size={gridSize} onChange={handleGridChange} />
            </div>
            <FileInput
              filename={filename}
              onFilenameChange={setFilename}
              onFileLoad={handleFileLoad}
            />
            <Pagination
              current={currentPage}
              total={totalPages}
              pages={getPages}
              onChange={setCurrentPage}
            />
            <div
              className="grid gap-2"
              style={{
                gridTemplateColumns: `repeat(${gridSize}, minmax(0, 1fr))`,
              }}
            >
              {pageItems.map((item, index) => (
                <ImageCard
                  key={`${item.src}-${index}`}
                  item={item}
                  onClick={openModal}
                  filters={filters}
                />
              ))}
            </div>
            <Modal image={modalImage} onClose={closeModal} />
          </div>
        )
      }

      ReactDOM.render(<App />, document.getElementById('root'))
    </script>
  </body>
</html>
